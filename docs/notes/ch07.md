# 第7章 【主流的用户身份识别方式与权限控制】JWT令牌与Auth权限控制中间件

## 7-1 jsonwebtoken

如果账号密码验证通过，需要返回一个jwt令牌

```js
// core > utils.js
const generateToken = function(uid, scope) {
  const secretKey = global.config.security.secretKey;
  const expiresIn = global.config.security.expiresIn;
  return jwt.sign({
    uid,
    scope,
  }, config.privateKey, {
    expiresIn,
  });
}

// 全局配置中增加 config
security: {
    secretKey: "abcdefg",
    expiresIn: 60 * 60,
  }
}

// 返回token给用户
return generatorToken(user.id, 2);

ctx.body = {
  token
}
```

## 7-2 HttpBasicAuth传递令牌

**非公开的 api，需要携带 token 才可以访问**

```js
// middleware auth.js
const basicAuth = require('basic-auth');

class Auth {
  constructor () {

  }
  // m 是一个属性，并不是一个方法；
  get m() {
    return async (ctx, next) => {
      // 检测 token
      // HTTP Basic Authorization
      const toke = basicAuth(ctx.req);
    }
  }
}

module.exports = { Auth };
```

```js
router.get('/latest', new Auth().m, async (ctx, next) => {
  ....
})
```