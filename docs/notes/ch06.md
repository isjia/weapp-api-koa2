# 第6章 【构建用户身份系统】通用用户系统与小程序用户系统

## 6-1 用户注册与Sequelize新增数据

```js
// 获取并保存参数到数据库中

const Router = require('koa-router');
const router = new Router({
  prefix: '/v1/user',
});
const {
  RegisterValidator
} = require('../../validators/validator');
const {User} = require('../../models/user');

// user 注册
router.post('/register', async (ctx) => {
  // 1. 参数校验
  const v = await new RegisterValidator().validate(ctx);

  // 2. 从校验器中获取参数
  const user = {
    email: v.get('body.email'),
    password: v.get('body.password1'),
    nickname: v.get('body.nickname'),
  }

  const r = await User.create(user);
})

module.exports = router;
```

### 增加验证 email 唯一

```js
const {User} = require('../models/user');

async validateEmail(vals) {
 const email = vals.bady.email;

 const user = await User.findOne({
   where: {
     email: email
   }
 })

 if (user) {
   throw Error('email 已存在');
 }
}
```

**注意需要改用 `lin-validateor-v2.js`，调用 validator 之前必须加上 await。**

## 6-2 中间件只在应用程序启动时初始化一次

### 为什么不用中间件的方式来实现校验器？

- 中间件只实例化一次
- 全局只有一个 validator，不能挂载属性值
- 每个请求需要独立的 validator

## 6-3 盐与密码加密的小知识

**密码必须加密，不能以明文存储；两个用户即使密码相同存储的密码也不能相同；**

### 借助第三方库实现

`npm install --save bcryptjs`

```js
// api>v1>user.js
const bcrpty = require('bcryptjs');

...

// 生成盐，10 是生成盐所花费的成本（实际），数字越大成本越高，安全性也越高
const salt = bcrypt.genSaltSync(10);
const psw = bcrypt.hashSync(v.get('body.password1'), salt);

...
// 存储加过盐之后的密码
```
