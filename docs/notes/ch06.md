# 第6章 【构建用户身份系统】通用用户系统与小程序用户系统

## 6-1 用户注册与Sequelize新增数据

```js
// 获取并保存参数到数据库中

const Router = require('koa-router');
const router = new Router({
  prefix: '/v1/user',
});
const {
  RegisterValidator
} = require('../../validators/validator');
const {User} = require('../../models/user');

// user 注册
router.post('/register', async (ctx) => {
  // 1. 参数校验
  const v = await new RegisterValidator().validate(ctx);

  // 2. 从校验器中获取参数
  const user = {
    email: v.get('body.email'),
    password: v.get('body.password1'),
    nickname: v.get('body.nickname'),
  }

  const r = await User.create(user);
})

module.exports = router;
```

### 增加验证 email 唯一

```js
const {User} = require('../models/user');

async validateEmail(vals) {
 const email = vals.bady.email;

 const user = await User.findOne({
   where: {
     email: email
   }
 })

 if (user) {
   throw Error('email 已存在');
 }
}
```

**注意需要改用 `lin-validateor-v2.js`，调用 validator 之前必须加上 await。**

